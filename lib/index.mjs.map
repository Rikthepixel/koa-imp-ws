{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import http from \"http\";\nimport process from \"process\";\nimport WebSocket, { ServerOptions } from \"ws\";\nimport Koa, { Middleware } from \"koa\";\n\nimport makeDebug from \"debug\";\nconst debug = makeDebug(\"koa-imp-ws\");\n\nexport type WebSocketContext = {\n  ws: () => Promise<WebSocket>;\n  wsServer?: WebSocket.Server;\n};\n\nexport type WebSocketMiddleware = Middleware<object, WebSocketContext>;\n\nexport type WebSocketMiddlwareOptions = {\n  server?: http.Server;\n  wsOptions?: ServerOptions;\n  noServerWorkaround?: boolean;\n};\n\nconst serversPatched = new WeakSet();\n\nfunction websocket(\n  optionsOrHttpServer?: WebSocketMiddlwareOptions | http.Server,\n): (\n  context: Koa.ParameterizedContext<object, WebSocketContext>,\n  next: Koa.Next,\n) => any {\n  const options: WebSocketMiddlwareOptions =\n    optionsOrHttpServer instanceof http.Server\n      ? { server: optionsOrHttpServer }\n      : optionsOrHttpServer ?? {};\n\n  if (parseInt(process.versions.node) < 10 && !options.noServerWorkaround) {\n    const server = options.server;\n    // node 9 or earlier needs a workaround for upgrade requests\n    if (!server) {\n      throw new TypeError(\n        `If you target Node 9 or earlier you must provide the HTTP server either as an option or as the second parameter.\\n` +\n          `See the readme for more instructions: https://github.com/b3nsn0w/koa-easy-ws#special-usage-for-node-9-or-earlier`,\n      );\n    }\n\n    if (!serversPatched.has(server)) {\n      serversPatched.add(server);\n      server.on(\"upgrade\", (req) =>\n        server.emit(\"request\", req, new http.ServerResponse(req)),\n      );\n      debug(\"added workaround to a server\");\n    }\n  }\n\n  debug(`websocket middleware created with property name 'wsServer`);\n\n  const wsServer = new WebSocket.Server({\n    ...options.wsOptions,\n    noServer: true,\n  });\n\n  return async function (ctx, next) {\n    debug(`websocket middleware called on route ${ctx.path}`);\n    const shouldUpgradeWs =\n      (ctx.request.headers.upgrade || \"\")\n        .split(\",\")\n        .map((s) => s.trim().toLowerCase())\n        .indexOf(\"websocket\") !== -1;\n\n    if (!shouldUpgradeWs) {\n      return await next();\n    }\n\n    debug(`websocket middleware in use on route ${ctx.path}`);\n\n    ctx.ws = async function () {\n      return new Promise<WebSocket>(function (resolve) {\n        wsServer.handleUpgrade(\n          ctx.req,\n          ctx.request.socket,\n          Buffer.alloc(0),\n          (ws) => {\n            wsServer.emit(\"connection\", ws, ctx.req);\n            resolve(ws);\n          },\n        );\n        ctx.respond = false;\n      });\n    };\n\n    ctx.wsServer = wsServer;\n\n    await next();\n  };\n}\n\nexport default websocket;\n"],"mappings":";AAAA,OAAO,UAAU;AACjB,OAAO,aAAa;AACpB,OAAO,eAAkC;AAGzC,OAAO,eAAe;AACtB,IAAM,QAAQ,UAAU,YAAY;AAepC,IAAM,iBAAiB,oBAAI,QAAQ;AAEnC,SAAS,UACP,qBAIO;AACP,QAAM,UACJ,+BAA+B,KAAK,SAChC,EAAE,QAAQ,oBAAoB,IAC9B,uBAAuB,CAAC;AAE9B,MAAI,SAAS,QAAQ,SAAS,IAAI,IAAI,MAAM,CAAC,QAAQ,oBAAoB;AACvE,UAAM,SAAS,QAAQ;AAEvB,QAAI,CAAC,QAAQ;AACX,YAAM,IAAI;AAAA,QACR;AAAA;AAAA,MAEF;AAAA,IACF;AAEA,QAAI,CAAC,eAAe,IAAI,MAAM,GAAG;AAC/B,qBAAe,IAAI,MAAM;AACzB,aAAO;AAAA,QAAG;AAAA,QAAW,CAAC,QACpB,OAAO,KAAK,WAAW,KAAK,IAAI,KAAK,eAAe,GAAG,CAAC;AAAA,MAC1D;AACA,YAAM,8BAA8B;AAAA,IACtC;AAAA,EACF;AAEA,QAAM,2DAA2D;AAEjE,QAAM,WAAW,IAAI,UAAU,OAAO;AAAA,IACpC,GAAG,QAAQ;AAAA,IACX,UAAU;AAAA,EACZ,CAAC;AAED,SAAO,eAAgB,KAAK,MAAM;AAChC,UAAM,wCAAwC,IAAI,IAAI,EAAE;AACxD,UAAM,mBACH,IAAI,QAAQ,QAAQ,WAAW,IAC7B,MAAM,GAAG,EACT,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,YAAY,CAAC,EACjC,QAAQ,WAAW,MAAM;AAE9B,QAAI,CAAC,iBAAiB;AACpB,aAAO,MAAM,KAAK;AAAA,IACpB;AAEA,UAAM,wCAAwC,IAAI,IAAI,EAAE;AAExD,QAAI,KAAK,iBAAkB;AACzB,aAAO,IAAI,QAAmB,SAAU,SAAS;AAC/C,iBAAS;AAAA,UACP,IAAI;AAAA,UACJ,IAAI,QAAQ;AAAA,UACZ,OAAO,MAAM,CAAC;AAAA,UACd,CAAC,OAAO;AACN,qBAAS,KAAK,cAAc,IAAI,IAAI,GAAG;AACvC,oBAAQ,EAAE;AAAA,UACZ;AAAA,QACF;AACA,YAAI,UAAU;AAAA,MAChB,CAAC;AAAA,IACH;AAEA,QAAI,WAAW;AAEf,UAAM,KAAK;AAAA,EACb;AACF;AAEA,IAAO,cAAQ;","names":[]}